services:
  # --- THE HERMITCLAW INFRASTRUCTURE ---

  # 1. The Hermit Shell (Gateway + UI)
  hermit_shell:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hermit_shell
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://hermit:${DB_PASSWORD}@hermit_db:5432/hermitclaw
      - MASTER_PEARL=${MASTER_PEARL}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
      - NODE_ENV=production
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
    depends_on:
      hermit_db:
        condition: service_healthy
    networks:
      - sand_bed
      - open_ocean

  # 2. The Pearl Vault (DB)
  hermit_db:
    image: postgres:16-alpine
    container_name: hermit_db
    restart: unless-stopped
    # No `ports:` here intentionally — the DB must not be reachable from the
    # host network. hermit_shell connects via the Docker network name (hermit_db)
    # over open_ocean. Exposing 5432 on the host would allow any local process
    # (or network attacker) to connect directly with the DB credentials.
    environment:
      POSTGRES_USER: hermit
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: hermitclaw
    volumes:
      - hermit_data:/var/lib/postgresql/data
    networks:
      - open_ocean
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hermit -d hermitclaw"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- AGENT CONTAINERS (clawbots) ---
  # Each agent runs on sand_bed only (no direct internet access).
  # Outbound HTTPS flows through the Hermit Shell CONNECT proxy.
  # The Hermit Shell reverse-proxies the agent's web UI at /agents/<name>/.
  #
  # Example: OpenClaw agent.
  # Uncomment and configure, or use scripts/clawbot-add.sh to provision automatically.

  # openclaw:
  #   image: ghcr.io/openclaw/openclaw:latest   # replace with actual image
  #   container_name: openclaw
  #   restart: unless-stopped
  #   read_only: true                            # filesystem hardening
  #   tmpfs:
  #     - /tmp:size=128m,noexec,nosuid           # writable scratch space only
  #   environment:
  #     - HTTP_PROXY=http://hermit_shell:3000    # all outbound HTTPS via Hermit Shell
  #     - HTTPS_PROXY=http://hermit_shell:3000
  #     - NO_PROXY=hermit_shell                  # don't proxy the proxy itself
  #     - HERMITCLAW_TOKEN=${OPENCLAW_TOKEN}     # agent bearer token
  #     - HERMITCLAW_BASE_URL=http://hermit_shell:3000
  #   volumes:
  #     - openclaw_data:/data                    # persistent agent state
  #   networks:
  #     - sand_bed                               # isolated — no internet access
  #   # No `ports:` — UI is accessed via the Hermit Shell reverse proxy at
  #   # /agents/openclaw/. uiPort must be set on the Crab record in HermitClaw.

networks:
  sand_bed:
    internal: true   # STRICT ISOLATION — no internet access
  open_ocean:
    driver: bridge   # Internet access

volumes:
  hermit_data:
  # openclaw_data:   # uncomment when adding the openclaw service
