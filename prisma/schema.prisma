// HermitClaw — Prisma Schema
// The Pearl Vault database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------
// Crabs — registered agents
// -----------------------------------------------
model Crab {
  id           String    @id @default(cuid())
  name         String    @unique
  token        String    @unique  // Bearer token the agent presents
  expiresAt    DateTime?
  active       Boolean   @default(true)
  allowedTools Json?     // null = unrestricted; array of { url, method } objects
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  pearls Pearl[]
  tides  Tide[]

  @@map("crabs")
}

// -----------------------------------------------
// Pearls — encrypted credentials
// -----------------------------------------------
model Pearl {
  id            String   @id @default(cuid())
  crabId        String
  service       String   // e.g. "github", "slack"
  label         String?  // human-readable description
  encryptedBlob String   // AES-256-GCM ciphertext (hex)
  iv            String   // initialization vector (hex)
  authTag       String   // GCM auth tag (hex)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  crab Crab @relation(fields: [crabId], references: [id], onDelete: Cascade)

  @@unique([crabId, service])
  @@map("pearls")
}

// -----------------------------------------------
// Tides — audit log of all traffic
// -----------------------------------------------
model Tide {
  id           String   @id @default(cuid())
  crabId       String?
  direction    Direction
  tool         String?  // e.g. "github_star"
  targetUrl    String?
  statusCode   Int?
  requestBody  String?  // sanitized
  responseBody String?  // sanitized
  error        String?
  createdAt    DateTime @default(now())

  crab Crab? @relation(fields: [crabId], references: [id], onDelete: SetNull)

  @@map("tides")
}

// -----------------------------------------------
// Routes — ingress routing rules (Phase 8D)
// -----------------------------------------------
model Route {
  id          String   @id @default(cuid())
  provider    String   // e.g. "signal", "whatsapp"
  matchPrefix String   // e.g. "@supportbot"
  targetCrab  String   // container name to forward to
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("routes")
}

// -----------------------------------------------
// ModelProvider — LLM backends (Phase 8A)
// -----------------------------------------------
model ModelProvider {
  id          String        @id @default(cuid())
  name        String        @unique // e.g. "ollama-local", "openai"
  baseUrl     String        // e.g. "http://host.docker.internal:11434"
  protocol    Protocol      @default(OPENAI)
  pearlService String?      // if set, look up this pearl service name for the API key
  scope       ProviderScope @default(GLOBAL)
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  access ModelProviderAccess[]

  @@map("model_providers")
}

// -----------------------------------------------
// ModelProviderAccess — join: RESTRICTED provider → crab (Phase 8A)
// -----------------------------------------------
model ModelProviderAccess {
  id         String   @id @default(cuid())
  providerId String
  crabId     String
  createdAt  DateTime @default(now())

  provider ModelProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, crabId])
  @@map("model_provider_access")
}

// -----------------------------------------------
// ConnectRule — CONNECT proxy domain policy (Phase 8B)
// -----------------------------------------------
model ConnectRule {
  id        String     @id @default(cuid())
  domain    String     // e.g. "*.telegram.org", "api.openai.com"
  action    RuleAction
  crabId    String?    // null = global rule
  priority  Int        @default(100)
  note      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("connect_rules")
}

// -----------------------------------------------
// SystemSetting — global key-value config (Phase 8B)
// -----------------------------------------------
model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

enum Direction {
  EGRESS   // agent → shell → internet
  INGRESS  // internet → shell → agent
}

enum Protocol {
  OPENAI     // OpenAI-compatible chat completions API
  ANTHROPIC  // Anthropic messages API (future)
}

enum ProviderScope {
  GLOBAL     // any crab can use this provider
  RESTRICTED // only crabs in ModelProviderAccess can use it
}

enum RuleAction {
  ALLOW
  DENY
}
